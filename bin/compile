#!/bin/bash

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}


# Path of mzoon root directory
MZOON_BUILD_PATH="."


# From https://devcenter.heroku.com/articles/buildpack-api
export_env_dir() {
  env_dir=$1
  acceptlist_regex=${2:-''}
  denylist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for e in $(ls $env_dir); do
      echo "$e" | grep -E "$acceptlist_regex" | grep -qvE "$denylist_regex" &&
      export "$e=$(cat $env_dir/$e)"
      :
    done
  fi
}

export_env_dir "$ENV_DIR"


mkdir -p "$CACHE_DIR"
cd "$CACHE_DIR"

export RUSTUP_HOME="$CACHE_DIR/rustup"
export CARGO_HOME="$CACHE_DIR/cargo"

if [ -d "$CARGO_HOME" ]; then
    echo "-----> Check for up-to-date Rust installation"
    source "$CARGO_HOME/env"
    rustup self update
    rustup update stable
else
    echo "-----> Installing Rust"
    curl https://sh.rustup.rs -sSf > rustup.sh
    chmod u+x rustup.sh
    ./rustup.sh -y --default-toolchain stable
    rm rustup.sh
    source "$CARGO_HOME/env"
fi

# Store all generated artifacts in cache dir
export CARGO_TARGET_DIR="$CACHE_DIR/target"

echo "-----> Installing MZoon"
echo "Entering MZOON_BUILD_PATH: $MZOON_BUILD_PATH"
cd "$BUILD_DIR/$MZOON_BUILD_PATH"
cargo install mzoon --git https://github.com/MoonZoon/MoonZoon --rev $(<mzoon_commit) --root "$CACHE_DIR/mzoon_install_root" --locked
MZOON="$CACHE_DIR/mzoon_install_root/bin/mzoon"


echo "-----> Building app"
"$MZOON" build -r
mkdir -p target/release
find "$CARGO_TARGET_DIR/release" -maxdepth 1 -type f -executable -exec cp -a -t target/release {} \;
